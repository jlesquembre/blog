<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Running a local dns and web server | Lafuente</title><meta name="Description" content="I am writing about my experiences as a software developer."><link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="Lafuente"><style>*,::after,::before{box-sizing:border-box}ol[class],ul[class]{padding:0}blockquote,body,dd,dl,figure,h1,h2,h3,h4,ol[class],p,ul[class]{margin:0}body{min-height:100vh;scroll-behavior:smooth;text-rendering:optimizeSpeed;line-height:1.5}ol[class],ul[class]{list-style:none}a:not([class]){text-decoration-skip-ink:auto}img{max-width:100%;display:block}article>*+*{margin-top:1em}button,input,select,textarea{font:inherit}img:not([alt]){filter:blur(10px)}@media(prefers-reduced-motion:reduce){*{animation-duration:NaNs!important;animation-iteration-count:1!important;transition-duration:NaNs!important;scroll-behavior:auto!important}}:root{--bg:#fafafa;--fg:#6c7680;--ui:#959da6;--text:#000000;--tag:#399ee6;--link:#399ee6;--side-bg:#1f2430;--side-fg:#cbccc6;--side-ui:#707a8c;--bg-m:#1f2430}*{box-sizing:border-box}:root{font-size:clamp(1rem,1.5vw,1.25rem)}.date-side,.date-tags-container,.tags-side{font-size:.8rem}body,html{padding:0;margin:0;font-family:system-ui,sans-serif;background-color:var(--bg)}html{height:100%}body{display:grid;grid-template-rows:1fr auto;grid-template-columns:30% 1fr 2.5rem;grid-column-gap:1rem;grid-row-gap:0;min-height:100%}header{grid-column:1;grid-row:1/2}main{grid-column:2;grid-row:1/3;padding:1rem}footer{grid-column:1;grid-row:2/3;position:sticky;bottom:0;display:flex;justify-content:center}.side{background-color:var(--side-bg);color:var(--side-fg)}a,a:hover,a:visited{text-decoration:none;color:inherit}main.blog p{margin:1.5em 0}hr,main.blog li,main.blog p{max-width:80ch}main.blog a:not(.tag):not(.direct-link),main.blog a:not(.tag):not(.direct-link):visited{text-decoration:underline var(--link)}main.blog a:not(.tag):not(.direct-link):hover{color:var(--link);text-decoration:underline var(--link)}.title{padding:.5em 1em 0;display:inline-block;margin:0 0 1em 1em;background-color:var(--bg);color:var(--text)}.nav-item{padding:1.5em}.nav-item:hover{background-color:var(--ui);color:var(--text)}.nav-item-active,.nav-item-active:hover{font-weight:700;background-color:var(--bg);color:var(--text)}time{color:var(--fg)}.postlist-date{display:block}.postlist-item{margin:1.5em 0}.year-header{display:flex;color:var(--fg);border-bottom:1px dotted var(--fg)}.year-header>span{margin-left:auto}.year-header+.postlist-item{margin-top:0}.tag>span:first-child{color:var(--tag);padding:0 4px;border:1px solid rgba(0,0,0,.08)}.tag>span::before{content:""}.tag:hover>span:first-child{background-color:rgba(0,0,0,.08)}.tags-list{display:flex;flex-direction:column}.tags-list a{width:max-content}.tags-side span:first-child{border:none}.tags-side .tag:hover>span{background-color:var(--bg)}.direct-link{font-family:sans-serif;text-decoration:none;font-style:normal;margin-left:.1em}a[href].direct-link,a[href].direct-link:visited{color:transparent}:hover>a[href].direct-link,:hover>a[href].direct-link:visited,a[href].direct-link:focus,a[href].direct-link:focus:visited{color:#aaa}.sticky{position:sticky;top:1em}.summary-container{padding-top:30vh;display:grid;grid-template-columns:auto 1fr}.summary{padding:0 2em;margin:0 auto}.section-header{writing-mode:vertical-lr;text-orientation:upright;text-transform:capitalize}.social{display:flex;align-self:center;line-height:1em}.social svg{fill:var(--side-fg);width:2.5em}.icon-github svg:hover{fill:#000}.icon-twitter svg:hover{fill:#00c9ff}.icon-feed svg:hover{fill:#ff9132}a.social-icon{text-decoration:none;margin:0 .5em}#home{margin-left:auto;background-color:var(--bg);color:var(--fg);padding:.5em;text-decoration:none;display:none}#all-pages{display:block;background-color:#fff;position:fixed;padding:.25em;color:red;right:0}hr{margin:1em .5em}thead tr{background-color:var(--ui)}tbody tr:nth-child(2n){background-color:#dbdbdb}td,th{padding:0 1em}td[align=right],th[align=right]{text-align:right}table{border:1px solid hsla(0,0%,0%,.12);border-spacing:2px;margin:0;padding:0;margin-bottom:.8125rem;font-size:1rem;line-height:1.625rem;border-collapse:collapse}</style><link rel="stylesheet" href="/css/prism.css"></head><body><header class="side"><a href="/"><h1 class="title">Lafuente</h1></a><div class="sticky"><div class="social"><a class="social-icon icon-github" href="https://github.com/jlesquembre" title="@jlesquembre on GitHub"><svg viewBox="0 0 32 32"><path d="M16 0C7.163 0 0 7.163 0 16s7.163 16 16 16 16-7.163 16-16S24.837 0 16 0zm9.502 25.502a13.4 13.4 0 01-5.51 3.334v-2.398c0-1.26-.432-2.188-1.297-2.781.542-.052 1.039-.125 1.492-.219s.932-.229 1.438-.406.958-.388 1.359-.633.786-.563 1.156-.953.68-.833.93-1.328.448-1.089.594-1.781.219-1.456.219-2.289c0-1.615-.526-2.99-1.578-4.125.479-1.25.427-2.609-.156-4.078l-.391-.047c-.271-.031-.758.083-1.461.344s-1.492.688-2.367 1.281a14.367 14.367 0 00-3.859-.516c-1.344 0-2.625.172-3.844.516a13.39 13.39 0 00-1.57-.93c-.495-.245-.891-.411-1.188-.5s-.573-.143-.828-.164-.419-.026-.492-.016-.125.021-.156.031c-.583 1.479-.635 2.839-.156 4.078-1.052 1.135-1.578 2.51-1.578 4.125 0 .833.073 1.596.219 2.289s.344 1.286.594 1.781.56.938.93 1.328.755.708 1.156.953.854.456 1.359.633.984.313 1.438.406.951.167 1.492.219c-.854.583-1.281 1.51-1.281 2.781v2.445A13.4 13.4 0 016.5 25.501 13.4 13.4 0 012.563 16a13.4 13.4 0 013.936-9.502 13.4 13.4 0 014.272-2.881c1.654-.7 3.414-1.054 5.229-1.054s3.575.355 5.23 1.055a13.4 13.4 0 014.272 2.881A13.4 13.4 0 0129.438 16c0 1.815-.355 3.575-1.055 5.23a13.41 13.41 0 01-2.881 4.272z"/></svg> </a><a class="social-icon icon-twitter" href="https://twitter.com/jlesquembre" title="@jlesquembre on Twitter"><svg viewBox="0 0 32 32" fill="#00c9ff"><path d="M32 6.076a13.14 13.14 0 01-3.771 1.034 6.592 6.592 0 002.887-3.632 13.151 13.151 0 01-4.169 1.593 6.557 6.557 0 00-4.792-2.073 6.565 6.565 0 00-6.565 6.565c0 .515.058 1.016.17 1.496a18.64 18.64 0 01-13.532-6.86A6.536 6.536 0 001.339 7.5a6.563 6.563 0 002.921 5.465 6.54 6.54 0 01-2.974-.821l-.001.083a6.57 6.57 0 005.266 6.438 6.578 6.578 0 01-2.965.112 6.572 6.572 0 006.133 4.559 13.172 13.172 0 01-8.154 2.81c-.53 0-1.052-.031-1.566-.092a18.579 18.579 0 0010.064 2.95c12.076 0 18.679-10.004 18.679-18.68 0-.285-.006-.568-.019-.849A13.354 13.354 0 0032 6.076z"/></svg> </a><a class="social-icon icon-feed" href="/feed/feed.xml" title="José Luis Lafuente's RSS Feed"><svg viewBox="0 0 32 32" fill="#ff9132"><path d="M4.259 23.467A4.265 4.265 0 000 27.719a4.25 4.25 0 004.259 4.244 4.25 4.25 0 004.265-4.244c.001-2.336-1.906-4.252-4.265-4.252zM.005 10.873v6.133c3.993 0 7.749 1.562 10.577 4.391A14.897 14.897 0 0114.966 32h6.16C21.125 20.349 11.648 10.873.005 10.873zM.012 0v6.136C14.255 6.136 25.848 17.74 25.848 32H32C32 14.36 17.648 0 .012 0z"/></svg> </a><a href="/" id="home">Home</a></div><div class="summary-container"><h1 class="section-header">blog</h1><div class="summary"><div class="date-side">24 Jun 2020</div><h2>Running a local dns and web server</h2><div class="tags-list tags-side"><a href="/tags/dns" class="tag"><span>dns</span> </a><a href="/tags/nix" class="tag"><span>nix</span> </a><a href="/tags/webserver" class="tag"><span>webserver</span></a></div></div></div></div></header><main class="blog"><div class="date-tags-container"><time datetime="2020-06-24">24 Jun 2020</time> · <a href="/tags/dns" class="tag"><span>dns</span> </a><a href="/tags/nix" class="tag"><span>nix</span> </a><a href="/tags/webserver" class="tag"><span>webserver</span></a></div><h1>Running a local dns and web server</h1><p>As a software developer, I run multiple web services to be accessed only from localhost. While it is possible to access them on <code>http://localhost</code>, I prefer to have more descriptive urls, like <code>http://docs.local</code>.</p><p>I'm going to describe my <a href="https://nixos.org/">NixOS</a> setup to resolve <code>.local</code> domains to localhost and access my local web server. I'm using <a href="https://coredns.io/">CoreDNS</a> and <a href="https://caddyserver.com/">Caddy</a> to accomplish it. Keep in mind that while I'm showing nix configuration snippets, you could extract the configuration files and run a similar setup in any Linux distribution.</p><p>It is interesting to notice that <a href="https://coredns.io/">CoreDNS</a> started its life as a fork of <a href="https://caddyserver.com/">Caddy</a>.</p><h1 id="dns-server">DNS server <a class="direct-link" href="#dns-server">#</a></h1><p>While I could use <a href="http://www.thekelleys.org.uk/dnsmasq/doc.html">dnsmasq</a>, I wanted to try a newer DNS server, <a href="https://coredns.io/">CoreDNS</a>. Let's start the service with some custom configuration:</p><pre class="language-nix"><code class="language-nix">services<span class="token punctuation">.</span>coredns<span class="token punctuation">.</span>enable <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><br>services<span class="token punctuation">.</span>coredns<span class="token punctuation">.</span>config <span class="token operator">=</span><br>  <span class="token string">''<br>    . {<br>      # Cloudflare and Google<br>      forward . 1.1.1.1 1.0.0.1 8.8.8.8 8.8.4.4<br>      cache<br>    }<br><br>    local {<br>      template IN A  {<br>          answer "{{ .Name }} 0 IN A 127.0.0.1"<br>      }<br>    }<br>  ''</span><span class="token punctuation">;</span></code></pre><p>The first block will forward all the DNS requests to Cloudflare and Google DNS servers, and the results will be cached (1 hour by default)</p><p>The second block returns an A record with value <code>127.0.0.1</code> for any request for a <code>.local</code> domain.</p><p>So far, so good, we have a local DNS server up and running. Now we need to configure our network manager to use that DNS server. If you are on <a href="https://nixos.org/">NixOS</a>, that's pretty easy:</p><pre class="language-nix"><code class="language-nix">networking<span class="token punctuation">.</span>networkmanager<span class="token punctuation">.</span>insertNameservers <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token string">"127.0.0.1"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre><h1 id="web-server">Web server <a class="direct-link" href="#web-server">#</a></h1><p>I could use <a href="https://nginx.org/en/docs/">nginx</a>, but I decided to use <a href="https://caddyserver.com/">Caddy</a> instead because it comes with an HTTP API out of the box. I'm not explaining it in this post, but <a href="https://caddyserver.com/">Caddy</a>'s API opens the door to many interesting possibilities.</p><p>Let's take a look our <code>Caddyfile</code> configuration:</p><pre><code>http://docs.local {
  root * /path/to/dir
  file_server
}
</code></pre><p>Here we are saying that all requests to <code>http://docs.local</code> should serve static files located at <code>/path/to/dir</code>.</p><p>Until <a href="https://github.com/NixOS/nixpkgs/pull/86686">#86686</a> is merged, you need to create your own systemd unit to start <a href="https://caddyserver.com/">Caddy</a>:</p><pre class="language-nix"><code class="language-nix"><span class="token keyword">let</span><br>  caddyConfig <span class="token operator">=</span> pkgs<span class="token punctuation">.</span>writeText <span class="token string">"Caddyfile"</span><br>    <span class="token string">''<br>      http://docs.local {<br>        root * /path/to/dir<br>        file_server<br>      }<br>    ''</span><span class="token punctuation">;</span><br><span class="token keyword">in</span><br><span class="token punctuation">{</span><br>  systemd<span class="token punctuation">.</span>services<span class="token punctuation">.</span>caddy <span class="token operator">=</span> <span class="token punctuation">{</span><br>    description <span class="token operator">=</span> <span class="token string">"Caddy web server"</span><span class="token punctuation">;</span><br>    after <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token string">"network-online.target"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><br>    wants <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token string">"network-online.target"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><br>    wantedBy <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token string">"multi-user.target"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><br>    serviceConfig <span class="token operator">=</span> <span class="token punctuation">{</span><br>      User <span class="token operator">=</span> <span class="token string">"caddy"</span><span class="token punctuation">;</span><br>      Group <span class="token operator">=</span> <span class="token string">"caddy"</span><span class="token punctuation">;</span><br>      ExecStart <span class="token operator">=</span> <span class="token string">''<br>        <span class="token interpolation"><span class="token antiquotation variable">$</span><span class="token punctuation">{</span>pkgs<span class="token punctuation">.</span>caddy2<span class="token punctuation">}</span></span>/bin/caddy run --config <span class="token interpolation"><span class="token antiquotation variable">$</span><span class="token punctuation">{</span>caddyConfig<span class="token punctuation">}</span></span> --adapter caddyfile<br>      ''</span><span class="token punctuation">;</span><br>      ExecReload <span class="token operator">=</span> <span class="token string">''<br>        <span class="token interpolation"><span class="token antiquotation variable">$</span><span class="token punctuation">{</span>pkgs<span class="token punctuation">.</span>caddy2<span class="token punctuation">}</span></span>/bin/caddy reload --config <span class="token interpolation"><span class="token antiquotation variable">$</span><span class="token punctuation">{</span>caddyConfig<span class="token punctuation">}</span></span> --adapter caddyfile<br>      ''</span><span class="token punctuation">;</span><br>      TimeoutStopSec <span class="token operator">=</span> <span class="token string">"5s"</span><span class="token punctuation">;</span><br>      LimitNOFILE <span class="token operator">=</span> <span class="token number">1048576</span><span class="token punctuation">;</span><br>      LimitNPROC <span class="token operator">=</span> <span class="token number">512</span><span class="token punctuation">;</span><br>      PrivateTmp <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><br>      ProtectSystem <span class="token operator">=</span> <span class="token string">"full"</span><span class="token punctuation">;</span><br>      AmbientCapabilities <span class="token operator">=</span> <span class="token string">"cap_net_bind_service"</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br><br>  users<span class="token punctuation">.</span>users<span class="token punctuation">.</span>caddy <span class="token operator">=</span> <span class="token punctuation">{</span><br>    group <span class="token operator">=</span> <span class="token string">"caddy"</span><span class="token punctuation">;</span><br>    uid <span class="token operator">=</span> config<span class="token punctuation">.</span>ids<span class="token punctuation">.</span>uids<span class="token punctuation">.</span>caddy<span class="token punctuation">;</span><br>    home <span class="token operator">=</span> caddyDir<span class="token punctuation">;</span><br>    createHome <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><br>    extraGroups <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token string">"users"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br><br>  users<span class="token punctuation">.</span>groups<span class="token punctuation">.</span>caddy<span class="token punctuation">.</span>gid <span class="token operator">=</span> config<span class="token punctuation">.</span>ids<span class="token punctuation">.</span>uids<span class="token punctuation">.</span>caddy<span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p><a href="/">← Home</a></p></main><footer class="side"><a href="/about"><div class="nav-item">About</div></a><a href="/tags"><div class="nav-item">Categories</div></a><a href="/posts"><div class="nav-item">Archives</div></a></footer></body></html>